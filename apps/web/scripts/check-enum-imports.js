#!/usr/bin/env node

/**
 * Prisma Enum Import Checker
 *
 * PROBLEM:
 * Importing Prisma enums from @/generated/prisma/client causes Next.js bundling
 * errors in production when used in client components. This happens because
 * Prisma Client depends on Node.js modules that can't be bundled for the browser.
 *
 * SOLUTION:
 * Always import enums from @/generated/prisma/enums (auto-generated by Prisma).
 * This file contains plain TypeScript enums safe for client-side use.
 *
 * WHAT THIS SCRIPT DOES:
 * 1. Scans all .ts/.tsx files for imports from @/generated/prisma/client
 * 2. Checks if any enum values are imported (not just types)
 * 3. Reports files with problematic imports and exits with error code 1
 *
 * USAGE:
 * - Manually: pnpm check-enums (from apps/web)
 * - CI/CD: Runs in GitHub Actions before tests
 * - Performance: ~0.8 seconds for full codebase scan
 *
 * EXAMPLES OF ISSUES CAUGHT:
 * âŒ Enum value import from client (causes bundling errors)
 * âŒ Mixed enum and type imports from client
 * âœ… Enum import from enums file (safe for client components)
 * âœ… Type-only import from client (always safe)
 */

const { execSync } = require("node:child_process");
const fs = require("node:fs");

// All Prisma enums that should be imported from @/generated/prisma/enums
const PRISMA_ENUMS = [
  "ActionType",
  "LogicalOperator",
  "SystemType",
  "ExecutedRuleStatus",
  "PremiumTier",
  "NewsletterStatus",
  "ColdEmailStatus",
  "GroupItemType",
  "ReferralStatus",
  "ScheduledActionStatus",
  "DigestStatus",
  "Frequency",
  "CleanAction",
  "ThreadTrackerType",
];

console.log("ðŸ” Checking for problematic Prisma enum imports...\n");

try {
  // Search for files importing from @/generated/prisma/client (from current directory)
  const grepCommand =
    'grep -r "from \\"@/generated/prisma/client\\"" . --include="*.tsx" --include="*.ts" -l';

  let files;
  try {
    files = execSync(grepCommand, { encoding: "utf-8" })
      .trim()
      .split("\n")
      .filter(Boolean);
  } catch {
    console.log("âœ… No imports from @/generated/prisma/client found!");
    process.exit(0);
  }

  const problematicFiles = [];

  for (const file of files) {
    const content = fs.readFileSync(file, "utf-8");

    // Normalize multiline imports to single line for easier parsing
    const normalizedContent = content.replace(
      /import\s+\{[\s\S]*?\}\s+from\s+"[^"]+"/g,
      (match) => {
        return match.replace(/\s+/g, " ");
      },
    );

    // Find all imports from @/generated/prisma/client
    const importRegex =
      /import\s+(\{[^}]+\}|type\s+\{[^}]+\})\s+from\s+"@\/generated\/prisma\/client"/g;

    const matches = normalizedContent.matchAll(importRegex);
    for (const match of matches) {
      const importStatement = match[0];
      const importedItems = match[1];

      // Skip pure type imports: import type { ... }
      if (importStatement.startsWith("import type")) {
        continue;
      }

      // Check for enum imports as values (not type-prefixed)
      for (const enumName of PRISMA_ENUMS) {
        // Match enum name that is NOT preceded by "type "
        // Positive cases: { EnumName }, { foo, EnumName }, { EnumName, bar }
        // Negative cases: { type EnumName }, { type EnumName, ... }
        const valueImportPattern = new RegExp(
          `(?<!type\\s)\\b${enumName}\\b(?!\\s*:)`,
        );

        if (valueImportPattern.test(importedItems)) {
          // Find the line number in original content
          const lineNumber = content
            .substring(0, match.index)
            .split("\n").length;

          problematicFiles.push({
            file: file.replace("./", ""),
            line: lineNumber,
            content: importStatement.replace(/\s+/g, " "),
            enum: enumName,
          });
          break;
        }
      }
    }
  }

  if (problematicFiles.length === 0) {
    console.log(
      "âœ… All enum imports are correctly using @/generated/prisma/enums!\n",
    );
    process.exit(0);
  }

  console.log(
    `âŒ Found ${problematicFiles.length} problematic enum import(s):\n`,
  );

  for (const { file, line, content, enum: enumName } of problematicFiles) {
    console.log(`${file}:${line}`);
    console.log(`  Enum: ${enumName}`);
    console.log(`  ${content}`);
    console.log("  âš ï¸  Should import from @/generated/prisma/enums instead\n");
  }

  console.log("\nðŸ’¡ Fix: Change enum imports to use @/generated/prisma/enums");
  console.log(
    '   Example: import { ActionType } from "@/generated/prisma/enums";\n',
  );

  process.exit(1);
} catch (error) {
  console.error("Error running check:", error.message);
  process.exit(1);
}
