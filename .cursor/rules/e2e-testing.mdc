---
description: E2E Flow Tests setup and debugging guide
globs: ["**/__tests__/e2e/**", ".github/workflows/e2e-flows.yml"]
---

# E2E Flow Tests

## Overview

E2E flow tests run real email workflows using Gmail and Outlook test accounts. They test the full flow: sending emails, webhook processing, and rule execution.

## Repository Setup

**Important**: E2E tests run from the **inbox-zero-e2e** repo, not the main repo.

- Main repo: `elie222/inbox-zero` (or `inbox-zero/inbox-zero`)
- E2E repo: `inbox-zero/inbox-zero-e2e`

The E2E repo has:
- `E2E_FLOWS_ENABLED=true` repository variable
- All required secrets for test accounts
- A GitHub Action that automatically syncs workflow files from `elie222/inbox-zero` main branch

## Syncing Workflow Files

The e2e repo has a GitHub Action (`sync-upstream.yml`) that pulls from the main repo's main branch. To get code/workflow changes to the e2e repo:

1. Merge your changes to `main` on `elie222/inbox-zero`
2. Run the sync workflow:
   ```bash
   gh workflow run sync-upstream.yml --repo inbox-zero/inbox-zero-e2e
   ```
3. Wait for sync to complete, then trigger E2E tests

**Do NOT manually copy files between repos** - use the sync action.

## Triggering Tests

```bash
# Trigger from the e2e repo
gh workflow run e2e-flows.yml --repo inbox-zero/inbox-zero-e2e --ref main

# With a specific test file
gh workflow run e2e-flows.yml --repo inbox-zero/inbox-zero-e2e --ref main -f test_file=full-reply-cycle

# Check run status
gh run list --repo inbox-zero/inbox-zero-e2e --workflow=e2e-flows.yml --limit 5

# Watch a run
gh run watch <run-id> --repo inbox-zero/inbox-zero-e2e
```

## Debugging with Logs

### Two Log Sources

1. **GitHub Actions logs** - inline with test output, useful for test context
2. **Axiom logs** - structured server logs, useful for querying specific events

### Axiom MCP

Use the Axiom MCP to query structured logs. The E2E dataset is called **`e2e`**.

```apl
# Get recent webhook processing logs
['e2e']
| where _time > ago(30m)
| where message contains "webhook" or message contains "Processing"
| project _time, level, message, ['fields.email'], ['fields.subject']
| order by _time desc
| limit 50

# Find ExecutedRule status updates
['e2e']
| where _time > ago(30m)
| where message contains "Updating ExecutedRule status"
| project _time, ['fields.status'], ['fields.executedRuleId'], ['fields.subject']
| order by _time desc

# Check for skipped messages (label issues)
['e2e']
| where _time > ago(30m)
| where message contains "Skipping message"
| project _time, message, ['fields.labelIds'], ['fields.subject']
| order by _time desc

# Query by email account
['e2e']
| where _time > ago(30m)
| where ['fields.email'] contains "outlook" or ['fields.userEmail'] contains "outlook"
| project _time, level, message
| order by _time desc
```

### GitHub Actions Logs

```bash
# View logs for a specific run
gh run view <run-id> --repo inbox-zero/inbox-zero-e2e --log

# Download artifacts (includes server.log on failure)
gh run download <run-id> --repo inbox-zero/inbox-zero-e2e
```

## Local Development

**Prerequisites:** Run `pnpm install` first to install dependencies.

Run E2E tests locally with `./scripts/run-e2e-local.sh`. Config lives at `~/.config/inbox-zero/.env.e2e`.

See `apps/web/__tests__/e2e/flows/README.md` for full setup instructions.

**Debug logs:** `/tmp/ngrok-e2e.log` (tunnel) and `/tmp/nextjs-e2e.log` (app)

## ⚠️ Critical: Never Bypass Production Flows

**E2E tests must test the REAL production flow.** If something appears "flaky", that's a configuration or infrastructure issue to fix, NOT a reason to bypass the flow.

### What NOT to do

❌ **Don't directly call internal functions to skip webhook delivery:**
```typescript
// WRONG: Bypassing webhook processing because it's "flaky"
await handleOutboundReply(message);  // Skips the real webhook flow
await processHistoryForUser(data);   // Skips HTTP transport validation
```

❌ **Don't add "fallback" triggers when webhooks don't arrive:**
```typescript
// WRONG: "If webhook doesn't arrive, trigger manually"
const tracker = await waitForThreadTracker(...).catch(() => {
  return triggerProcessingDirectly();  // Bypasses the real flow
});
```

### Why this matters

1. **Production reliability**: If webhooks are flaky in tests, they might be flaky in production too. Tests should catch this.
2. **Real coverage**: Bypassing flows means you're not testing what users actually experience.
3. **Hidden bugs**: A bypass can mask real issues like webhook URL misconfiguration, authentication failures, or timing bugs.

### What TO do instead

✅ **Fix the root cause:**
- Gmail webhooks timeout? → Configure Pub/Sub push URL in Google Cloud Console
- Outlook webhooks fail? → Set `WEBHOOK_URL` to your ngrok domain
- Tests are slow? → That's the real speed of the flow; don't hide it

✅ **Improve error messages:** Add clear diagnostics so failures point to the actual problem (see `polling.ts` timeout hints).

✅ **Let tests fail:** A failing E2E test due to webhook misconfiguration is CORRECT behavior. The test is doing its job.
