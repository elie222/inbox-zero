name: CLI Release

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: bun-darwin-arm64
            artifact: inbox-zero-darwin-arm64
          - os: macos-13
            target: bun-darwin-x64
            artifact: inbox-zero-darwin-x64
          - os: ubuntu-latest
            target: bun-linux-x64
            artifact: inbox-zero-linux-x64

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: cd packages/cli && bun install

      - name: Build binary
        run: |
          cd packages/cli
          bun build src/main.ts --compile --target=${{ matrix.target }} --outfile dist/${{ matrix.artifact }}

      - name: Create tarball (Unix)
        run: |
          cd packages/cli/dist
          tar -czvf ${{ matrix.artifact }}.tar.gz ${{ matrix.artifact }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: packages/cli/dist/${{ matrix.artifact }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [ "${GITHUB_REF_TYPE}" != "tag" ]; then
            echo "This workflow must be run from a tag ref (got: ${GITHUB_REF_TYPE} '${GITHUB_REF_NAME}')" >&2
            exit 1
          fi
          VERSION="${GITHUB_REF_NAME#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

      - name: Calculate SHA256
        id: sha
        run: |
          echo "darwin_arm64=$(sha256sum artifacts/inbox-zero-darwin-arm64/inbox-zero-darwin-arm64.tar.gz | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
          echo "darwin_x64=$(sha256sum artifacts/inbox-zero-darwin-x64/inbox-zero-darwin-x64.tar.gz | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT
          echo "linux_x64=$(sha256sum artifacts/inbox-zero-linux-x64/inbox-zero-linux-x64.tar.gz | cut -d ' ' -f 1)" >> $GITHUB_OUTPUT

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            artifacts/inbox-zero-darwin-arm64/inbox-zero-darwin-arm64.tar.gz
            artifacts/inbox-zero-darwin-x64/inbox-zero-darwin-x64.tar.gz
            artifacts/inbox-zero-linux-x64/inbox-zero-linux-x64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Homebrew formula
        run: |
          python3 << 'EOF'
          import re
          
          with open('Formula/inbox-zero.rb', 'r') as f:
              content = f.read()
          
          # Update version
          content = re.sub(r'version "[^"]*"', 'version "${{ steps.version.outputs.version }}"', content)
          
          # Update URLs to current version (handles both cli-v* and v* formats)
          content = re.sub(r'releases/download/(?:cli-)?v[^/]+/', 'releases/download/${{ steps.version.outputs.tag }}/', content)
          
          # Update SHA256 for darwin-arm64 (first sha256 after "on_arm do")
          content = re.sub(
              r'(on_arm do.*?sha256 ")[^"]*(")',
              r'\g<1>${{ steps.sha.outputs.darwin_arm64 }}\2',
              content, count=1, flags=re.DOTALL
          )
          
          # Update SHA256 for darwin-x64 (first sha256 after "on_intel do" inside on_macos)
          content = re.sub(
              r'(on_macos do.*?on_intel do.*?sha256 ")[^"]*(")',
              r'\g<1>${{ steps.sha.outputs.darwin_x64 }}\2',
              content, count=1, flags=re.DOTALL
          )
          
          # Update SHA256 for linux-x64 (sha256 after "on_linux do")
          content = re.sub(
              r'(on_linux do.*?sha256 ")[^"]*(")',
              r'\g<1>${{ steps.sha.outputs.linux_x64 }}\2',
              content, count=1, flags=re.DOTALL
          )
          
          with open('Formula/inbox-zero.rb', 'w') as f:
              f.write(content)
          
          print(content)
          EOF

      - name: Commit formula update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Formula/inbox-zero.rb
          git diff --staged --quiet || git commit -m "chore: update Homebrew formula for ${{ steps.version.outputs.tag }}"
          git push origin HEAD:main

